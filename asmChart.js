//WinDbg script extension
//builds Visio diagram from function asm code
//requies installed Visio
//if you have any feedback please reach allavren@
//usage !asmchart "address" or !asmchart "module!function" 
//quotes around argument are required

"use strict";

function __asmChart(address)
{
    if (address==null){
        host.diagnostics.debugLog("builds Visio diagram from function asm code\n");
        host.diagnostics.debugLog("Usage: !asmchart \"address\" or !asmchart \"module!function\"\n");
        host.diagnostics.debugLog("quotes around argument are required\n");
        host.diagnostics.debugLog("Requires installed Visio\n");
        return;
    }
    var ctl = host.namespace.Debugger.Utility.Control;   
    var outputLines = ctl.ExecuteCommand("uf "+address);
    var filesystem = host.namespace.Debugger.Utility.FileSystem;
    var tempdir = filesystem.TempDirectory;
    var file = filesystem.CreateFile(tempdir+"\\asmcharttempfile.txt",2);
    var textWriter = host.namespace.Debugger.Utility.FileSystem.CreateTextWriter(file,2);
    textWriter.WriteLineContents(outputLines);
    file.Close();
    var file = filesystem.CreateFile(tempdir+"\\asmcharttempfile.cmd",2);
    var textWriter = host.namespace.Debugger.Utility.FileSystem.CreateTextWriter(file,0);
    //using weird base64 to avoid packing powershell to separate file
    //to get powershell source use  [system.text.encoding]::Unicode.GetString([convert]::FromBase64String(base64stringhere)) in powershell
    textWriter.WriteLine("powershell -encodedCommand JABhAHAAcABsAGkAYwBhAHQAaQBvAG4AIAA9ACAATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AQwBvAG0ATwBiAGoAZQBjAHQAIABWAGkAcwBpAG8ALgBBAHAAcABsAGkAYwBhAHQAaQBvAG4ADQAKACQAZABvAGMAdQBtAGUAbgB0AHMAIAA9ACAAJABhAHAAcABsAGkAYwBhAHQAaQBvAG4ALgBEAG8AYwB1AG0AZQBuAHQAcwANAAoAJABkAG8AYwB1AG0AZQBuAHQAIAA9ACAAJABkAG8AYwB1AG0AZQBuAHQAcwAuAEEAZABkACgAIgAiACkADQAKAA0ACgANAAoAJABwAGEAZwBlAHMAIAA9ACAAJABhAHAAcABsAGkAYwBhAHQAaQBvAG4ALgBBAGMAdABpAHYAZQBEAG8AYwB1AG0AZQBuAHQALgBQAGEAZwBlAHMADQAKACQAcABhAGcAZQAgAD0AIAAkAHAAYQBnAGUAcwAuAEkAdABlAG0AKAAxACkADQAKACQAcABhAGcAZQAuAFAAYQBnAGUAUwBoAGUAZQB0AC4AQwBlAGwAbABzAFUAKAAiAFAAbABhAGMAZQBTAHQAeQBsAGUAIgApAD0AMQA3ACAAIwAgAGgAaQBlAHIAYQByAGMAaAB5ACwAIAB0AG8AcAAgAHQAbwAgAGIAbwB0AHQAbwBtAA0ACgAkAHAAYQBnAGUALgBQAGEAZwBlAFMAaABlAGUAdAAuAEMAZQBsAGwAcwBVACgAIgBSAG8AdQB0AGUAUwB0AHkAbABlACIAKQA9ADEAIAAjAA0ACgAkAHAAYQBnAGUALgBQAGEAZwBlAFMAaABlAGUAdAAuAEMAZQBsAGwAcwBVACgAIgBMAGkAbgBlAFIAbwB1AHQAZQBFAHgAdAAiACkAPQAyACAAIwBjAHUAcgB2AGUAZAANAAoAJABkAG8AYwB1AG0AZQBuAHQALgBHAGUAcwB0AHUAcgBlAEYAbwByAG0AYQB0AFMAaABlAGUAdAAuAEMAZQBsAGwAcwBVACgAIgBDAGgAYQByAC4ARgBvAG4AdAAiACkAPQAkAGQAbwBjAHUAbQBlAG4AdAAuAEYAbwBuAHQAcwAuAEkAdABlAG0AKAAiAEMAbwBuAHMAbwBsAGEAcwAiACkALgBJAEQAIAAjAGYAbwBuAHQAIAB0AG8AIABjAG8AbgBzAG8AbABhAHMADQAKACQAZABvAGMAdQBtAGUAbgB0AC4ARwBlAHMAdAB1AHIAZQBGAG8AcgBtAGEAdABTAGgAZQBlAHQALgBDAGUAbABsAHMAVQAoACIAQwBoAGEAcgAuAFMAaQB6AGUAIgApAC4ARgBvAHIAbQB1AGwAYQBVAD0AIgA4ACAAcAB0ACIADQAKACQAZABvAGMAdQBtAGUAbgB0AC4ARwBlAHMAdAB1AHIAZQBGAG8AcgBtAGEAdABTAGgAZQBlAHQALgBDAGUAbABsAHMAVQAoACIAUABhAHIAYQAuAEgAbwByAHoAQQBsAGkAZwBuACIAKQA9ADAAIAAjAGEAbABpAGcAbgBsAGUAZgB0AA0ACgANAAoADQAKAA0ACgAkAHMAPQBHAGUAdAAtAEMAbwBuAHQAZQBuAHQAIAAtAGUAbgBjAG8AZABpAG4AZwAgAFUAbgBpAGMAbwBkAGUAIAAiACQAZQBuAHYAOgB0AGUAbQBwAFwAYQBzAG0AYwBoAGEAcgB0AHQAZQBtAHAAZgBpAGwAZQAuAHQAeAB0ACIAIAAtAHIAYQB3ACAADQAKACQAYgBsAG8AYwBrAHMAPQAkACgAJABzACAALQBzAHAAbABpAHQAIAAnACgAPwBtACkAKABeAFwAcwAqACQAKQAnACkADQAKACQAaQA9ADAADQAKAA0ACgAjAGQAcgBhAHcAIABzAGgAYQBwAGUAcwANAAoAWwBTAHkAcwB0AGUAbQAuAEMAbwBsAGwAZQBjAHQAaQBvAG4AcwAuAEEAcgByAGEAeQBMAGkAcwB0AF0AJABhAGwAbABzAGgAYQBwAGUAcwAgAD0AIABAACgAKQANAAoAZgBvAHIAZQBhAGMAaAAgACgAJABiAGwAbwBjAGsAIABpAG4AIAAkAGIAbABvAGMAawBzACkAewANAAoAaQBmACAAKAAkAGIAbABvAGMAawAuAEwAZQBuAGcAdABoACAALQBnAHQAIAAxACkAewANAAoAIAAkAG4AZQB3AHMAaABhAHAAZQA9ACQAcABhAGcAZQAuAEQAcgBhAHcAUgBlAGMAdABhAG4AZwBsAGUAKAAwACsAJABpACsAKwAsADAALAAwACwAMAApAA0ACgAgACQAbgBlAHcAcwBoAGEAcABlAC4AVABlAHgAdAA9ACQAYgBsAG8AYwBrAA0ACgAgACQAKAAkAG4AZQB3AHMAaABhAHAAZQAuAEMAZQBsAGwAcwBVACgAIgBXAGkAZAB0AGgAIgApACkALgBGAG8AcgBtAHUAbABhAFUAPQAiAEcAVQBBAFIARAAoAFQARQBYAFQAVwBJAEQAVABIACgAVABoAGUAVABlAHgAdAApACkAIgANAAoAIAAkACgAJABuAGUAdwBzAGgAYQBwAGUALgBDAGUAbABsAHMAVQAoACIASABlAGkAZwBoAHQAIgApACkALgBGAG8AcgBtAHUAbABhAFUAPQAiAEcAVQBBAFIARAAoAFQARQBYAFQASABFAEkARwBIAFQAKABUAGgAZQBUAGUAeAB0ACwAVwBpAGQAdABoACkAKQAiAA0ACgAgAA0ACgANAAoAIAAgACAAIAAgACMAYwBvAGwAbwByACAAdABvACAAYwBhAGwAbABzAA0ACgAgACAAIAAgAGYAbwByAGUAYQBjAGgAIAAoACQAbQAgAGkAbgAgACQAKABTAGUAbABlAGMAdAAtAFMAdAByAGkAbgBnACAAIgAoAD8AbQAtAGkAKQBjAGEAbABsACAAIAAgACAALgAqACQAIgAgAC0ASQBuAHAAdQB0AE8AYgBqAGUAYwB0ACAAJABuAGUAdwBzAGgAYQBwAGUALgBUAGUAeAB0ACAALQBBAGwAbABNAGEAdABjAGgAZQBzACkALgBNAGEAdABjAGgAZQBzACkAewANAAoAIAAgACAAIAAgACAAIAAgACQAYwBoAHIAPQAkAG4AZQB3AHMAaABhAHAAZQAuAEMAaABhAHIAYQBjAHQAZQByAHMADQAKACAAIAAgACAAIAAgACAAIAAkAGMAaAByAC4AQgBlAGcAaQBuAD0AJABtAC4ASQBuAGQAZQB4AA0ACgAgACAAIAAgACAAIAAgACAAJABjAGgAcgAuAEUAbgBkAD0AJABtAC4ASQBuAGQAZQB4ACsAJABtAC4AbABlAG4AZwB0AGgADQAKACAAIAAgACAAIAAgACAAIAAkAGMAaAByAC4AQwBoAGEAcgBQAHIAbwBwAHMAKAAxACkAPQAxADIADQAKACAAIAAgACAAfQANAAoAIAAgACAAIAAjAGMAbwBsAG8AcgAgAHQAbwAgAGIAcgBhAG4AYwBoAGUAcwANAAoAIAAgACAAIABmAG8AcgBlAGEAYwBoACAAKAAkAG0AIABpAG4AIAAkACgAUwBlAGwAZQBjAHQALQBTAHQAcgBpAG4AZwAgACIAKAA/AG0ALQBpACkAIAAgAEIAcgBhAG4AYwBoACIAIAAtAEkAbgBwAHUAdABPAGIAagBlAGMAdAAgACQAbgBlAHcAcwBoAGEAcABlAC4AVABlAHgAdAAgAC0AQQBsAGwATQBhAHQAYwBoAGUAcwApAC4ATQBhAHQAYwBoAGUAcwApAHsADQAKACAAIAAgACAAIAAgACAAIAAkAGMAaAByAD0AJABuAGUAdwBzAGgAYQBwAGUALgBDAGgAYQByAGEAYwB0AGUAcgBzAA0ACgAgACAAIAAgACAAIAAgACAAJABjAGgAcgAuAEIAZQBnAGkAbgA9ACQAbQAuAEkAbgBkAGUAeAANAAoAIAAgACAAIAAgACAAIAAgACQAYwBoAHIALgBFAG4AZAA9ACQAbQAuAEkAbgBkAGUAeAArACQAbQAuAGwAZQBuAGcAdABoAA0ACgAgACAAIAAgACAAIAAgACAAJABjAGgAcgAuAEMAaABhAHIAUAByAG8AcABzACgAMQApAD0ANAANAAoAIAAgACAAIAB9AA0ACgAgACAAIAAgACMAYwBvAGwAbwByACAAdABvACAAbgB1AG0AYgBlAHIAcwANAAoAIAAgACAAIABmAG8AcgBlAGEAYwBoACAAKAAkAG0AIABpAG4AIAAkACgAUwBlAGwAZQBjAHQALQBTAHQAcgBpAG4AZwAgACIAKAA/AC0AaQBtACkAKABbADAALQA5AEEALQBGAF0AKwBoACkAIgAgAC0ASQBuAHAAdQB0AE8AYgBqAGUAYwB0ACAAJABuAGUAdwBzAGgAYQBwAGUALgBUAGUAeAB0ACAALQBBAGwAbABNAGEAdABjAGgAZQBzACkALgBNAGEAdABjAGgAZQBzACkAewANAAoAIAAgACAAIAAgACAAIAAgACQAYwBoAHIAPQAkAG4AZQB3AHMAaABhAHAAZQAuAEMAaABhAHIAYQBjAHQAZQByAHMADQAKACAAIAAgACAAIAAgACAAIAAkAGMAaAByAC4AQgBlAGcAaQBuAD0AJABtAC4ASQBuAGQAZQB4AA0ACgAgACAAIAAgACAAIAAgACAAJABjAGgAcgAuAEUAbgBkAD0AJABtAC4ASQBuAGQAZQB4ACsAJABtAC4AbABlAG4AZwB0AGgADQAKACAAIAAgACAAIAAgACAAIAAkAGMAaAByAC4AQwBoAGEAcgBQAHIAbwBwAHMAKAAxACkAPQA5AA0ACgAgACAAIAAgAH0ADQAKAA0ACgAgACQAYQBsAGwAcwBoAGEAcABlAHMALgBBAGQAZAAoACQAbgBlAHcAcwBoAGEAcABlACkAIAANAAoAIAB9AA0ACgB9AA0ACgAjAGMAbwBsAG8AcgAgAA0ACgANAAoAZgBvAHIAZQBhAGMAaAAgACgAJABzAGgAYQBwAGUAIABpAG4AIAAkAGEAbABsAHMAaABhAHAAZQBzACkAewANAAoADQAKAH0AIAANAAoAIwBiAHUAaQBsAGQAIABjAG8AbgBuAGUAYwB0AGkAbwBuAHMADQAKACQAaQA9ADAADQAKAGYAbwByAGUAYQBjAGgAIAAoACQAcwBoAGEAcABlACAAaQBuACAAJABhAGwAbABzAGgAYQBwAGUAcwApAHsADQAKACAAIAAgACAAJABpACsAKwANAAoAIAAgACAAIABpAGYAIAAoACgAJABzAGgAYQBwAGUALgB0AGUAeAB0ACAALQBtAGEAdABjAGgAIAAiAGoAbQBwACAAIAAgACAAIAAiACkAIAAtAG8AcgAgACgAJABzAGgAYQBwAGUALgB0AGUAeAB0ACAALQBtAGEAdABjAGgAIAAiAHIAZQB0AFwAcwAkACIAKQAgAC0AbwByACAAKAAkAHMAaABhAHAAZQAuAHQAZQB4AHQAIAAtAG0AYQB0AGMAaAAgACIAcgBlAHQAIAAqAFsAMAAtADkAQQAtAEYAXQAqAFwAcwAkACIAKQApAHsAIAAjAGYAbwByACAAZQBhAGMAaAAgAGIAbABvAGMAawAgAHQAaABhAHQAIABkAG8AIABuAG8AdAAgAGoAdQBtAHAAIABvAHIAIAByAGUAdAAgAGMAbwBuAG4AZQBjAHQAIABpAHQAIAB3AGkAdABoACAAbgBlAHgAdAAgAHMAaABhAHAAZQANAAoAIAAgACAAIAAgACAAIAAgACIAagB1AG0AcABvAHIAcgBlAHQAIQAiAA0ACgAgACAAIAAgAH0ADQAKACAAIAAgACAAZQBsAHMAZQANAAoAIAAgACAAIAB7AA0ACgAgACAAIAAgACAAIAAgACAAJABzAGgAYQBwAGUALgBBAHUAdABvAEMAbwBuAG4AZQBjAHQAKAAkAGEAbABsAHMAaABhAHAAZQBzAFsAJABpAF0ALAAwACkADQAKACAAIAAgACAAIAAgACAAIAAkAHAAYQBnAGUALgBTAGgAYQBwAGUAcwBbACQAcABhAGcAZQAuAFMAaABhAHAAZQBzAC4AQwBvAHUAbgB0AF0ALgBDAGUAbABsAHMAVQAoACIARQBuAGQAQQByAHIAbwB3ACIAKQA9ADQAIAAgACMAYQByAHIAbwB3ACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgAA0ACgAgACAAIAAgAH0ADQAKAA0ACgB9AA0ACgANAAoADQAKAGYAbwByAGUAYQBjAGgAIAAoACQAcwBoAGEAcABlACAAaQBuACAAJABhAGwAbABzAGgAYQBwAGUAcwApAHsADQAKAA0ACgANAAoAIAAgACAAIABpAGYAIAAoACQAcwBoAGEAcABlAC4AdABlAHgAdAAgAC0AbQBhAHQAYwBoACAAIgAoAD8AbQApACgAXgAuACoAQgByAGEAbgBjAGgAKQAiACkAewAgACMAZgBvAHIAIABlAGEAYwBoACAAYgBsAG8AYwBrACAAdABoAGEAdAAgAGgAYQBzACAAYgByAGEAbgBjAGgADQAKACAAIAAgACAAIAAgACAAIAAkAGIAcgBhAG4AYwBoAGwAaQBuAGUAPQAkAE0AYQB0AGMAaABlAHMAWwAwAF0ADQAKACAAIAAgACAAIAAgACAAIAAkAGIAcgBhAG4AYwBoAGEAZABkAHIAZQBzAHMAPQAkAGIAcgBhAG4AYwBoAGwAaQBuAGUALgBTAHUAYgBzAHQAcgBpAG4AZwAoACQAYgByAGEAbgBjAGgAbABpAG4AZQAuAEwAYQBzAHQASQBuAGQAZQB4AE8AZgAoACcAKAAnACkAKwAxACwAJABiAHIAYQBuAGMAaABsAGkAbgBlAC4ATABhAHMAdABJAG4AZABlAHgATwBmACgAJwApACcAKQAtACQAYgByAGEAbgBjAGgAbABpAG4AZQAuAEwAYQBzAHQASQBuAGQAZQB4AE8AZgAoACcAKAAnACkALQAxACkADQAKACAAIAAgACAAIAAgACAAIAAkAGIAcgBhAG4AYwBoAGEAZABkAHIAZQBzAHMADQAKACAAIAAgACAAIAAgACAAIAAjAGYAaQBuAGQAIABjAG8AbgBuAGUAYwB0AGkAbwBuAHMADQAKACAAIAAgACAAIAAgACAAIABmAG8AcgBlAGEAYwBoACAAKAAkAHMAaABhAHAAZQAxACAAaQBuACAAJABhAGwAbABzAGgAYQBwAGUAcwApAHsADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgAGkAZgAgACgAJABzAGgAYQBwAGUAMQAuAHQAZQB4AHQAIAAtAG0AYQB0AGMAaAAgACIAKAA/AG0AKQAoAC4AKQAqACQAYgByAGEAbgBjAGgAYQBkAGQAcgBlAHMAcwAgACIAKQB7ACAAIwBmAGkAbgBkAGkAbgBnACAAYwBvAHIAcgBlAHMAcABvAG4AZABpAG4AZwAgAGIAbABvAGMAawANAAoAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAkAHMAaABhAHAAZQAuAEEAdQB0AG8AQwBvAG4AbgBlAGMAdAAoACQAcwBoAGEAcABlADEALAAwACkADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJABwAGEAZwBlAC4AUwBoAGEAcABlAHMAWwAkAHAAYQBnAGUALgBTAGgAYQBwAGUAcwAuAEMAbwB1AG4AdABdAC4AQwBlAGwAbABzAFUAKAAiAEwAaQBuAGUAQwBvAGwAbwByACIAKQA9ADQAIAAjAGMAbwBuAGQAaQB0AGkAbwBuAGEAbAAgAGMAbwBuAG4AZQBjAHQAbwByAHMAIABhAHIAZQAgAGIAbAB1AGUADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAJABwAGEAZwBlAC4AUwBoAGEAcABlAHMAWwAkAHAAYQBnAGUALgBTAGgAYQBwAGUAcwAuAEMAbwB1AG4AdABdAC4AQwBlAGwAbABzAFUAKAAiAEUAbgBkAEEAcgByAG8AdwAiACkAPQA0ACAAIAAjAGEAcgByAG8AdwAgACAAIAAgACAADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAIAAgACAAYgByAGUAYQBrACAAIAAgACAAIAAgACAAIAAgACAADQAKACAAIAAgACAAIAAgACAAIAAgACAAIAAgAH0ADQAKACAAIAAgACAAIAAgACAAIAB9AA0ACgANAAoAIAAgACAAIAB9AA0ACgANAAoAfQANAAoAJABwAGEAZwBlAC4ATABhAHkAbwB1AHQAKAApAA0ACgAkAHAAYQBnAGUALgBBAHUAdABvAFMAaQB6AGUARAByAGEAdwBpAG4AZwAoACkADQAKAA0ACgAkAGEAcABwAGwAaQBjAGEAdABpAG8AbgAuAHYAaQBzAGkAYgBsAGUAIAA9ACAAJAB0AHIAdQBlAA0ACgA=");
    file.Close();
    ctl.ExecuteCommand(".shell cmd /c %temp%\\asmcharttempfile.cmd");
    return;
}

function initializeScript()
{
    return [new host.apiVersionSupport(1, 2),new host.functionAlias(__asmChart, "asmchart")];

}
